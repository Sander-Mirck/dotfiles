name: NixOS CI

on:
  pull_request:
    branches: [main, stable, unstable]
    paths:
      - '**.nix'
      - 'flake.*'
      - '.github/workflows/**'
  push:
    branches: [main, stable, unstable]
    paths:
      - '**.nix'
      - 'flake.*'

permissions:
  contents: read

jobs:
  checks:
    name: Nix Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          
      - name: Format check (alejandra)
        run: nix run .#formatter.x86_64-linux -- --check .
        
      - name: Lint (statix)
        run: nix run github:nerdypepper/statix -- check .
        
      - name: Find unused code (deadnix)
        run: nix run github:astro/deadnix -- --fail .
        
      - name: Evaluate all configurations
        run: |
          nix flake check --show-trace
          nix eval .#nixosConfigurations --json
          
      - name: Build check
        run: |
          nix build .#nixosConfigurations.laptop.config.system.build.toplevel --no-link --print-build-logs
          
      - name: Check Home Manager
        run: |
          nix build .#homeConfigurations.sander.activationPackage --no-link --print-build-logs